<% resource_limit = 30 %>
<div class="row wrapper">
  <%- model_class = Profile -%>

  <!-- SIDEBAR -->
  <div id="sidebar" class="col-md-3">
    <ul class="unstyled nav-simple">
      <li><h4 class="nav-heading">Profile details</h4></li>
      <li style="padding: 10px 10px;">
        <div id="gravatar_image">
          <%= image_tag @user.gravatar_url, :class=>'medium-content-provider-logo' %>
        </div>
        <hr/>

        <p style="margin-bottom: 0px;">
          <strong><%= model_class.human_attribute_name(:firstname) %></strong>
        </p>
        <% if @user.profile.firstname.blank? %>
            <p class="empty">None specified</p>
        <% else %>
            <p><%= @user.profile.firstname %></p>
        <% end %>

        <p style="margin-bottom: 0px;">
          <strong><%= model_class.human_attribute_name(:surname) %></strong>
        </p>
        <% if @user.profile.surname.blank? %>
            <p class="empty">None specified</p>
        <% else %>
            <p><%= @user.profile.surname %></p>
        <% end %>

        <p style="margin-bottom: 0px;">
          <strong>Public email</strong>
        </p>
        <% if @user.profile.email.blank? %>
            <p class="empty">None specified</p>
        <% else %>
            <p><%= mail_to @user.profile.email %></p>
        <% end %>

        <p style="margin-bottom: 0px;">
          <strong><%= model_class.human_attribute_name(:website) %></strong>
        </p>
        <% if @user.profile.website.blank? %>
            <p class="empty">None specified</p>
        <% else %>
            <p><%= link_to @user.profile.website, @user.profile.website, rel: 'nofollow' %></p>
        <% end %>

        <% if !current_user.nil? and current_user == @user %>
            <div class="row">
              <%= link_to t('.edit', :default => 'Edit profile'), edit_user_path(@user), :class => 'btn btn-primary center-block' %>
            </div>
        <% end %>


      </li>
      <li><h4 class="nav-heading">Account details</h4></li>
      <li style="padding: 10px 10px;">
        <p style="margin-bottom: 0px;">
          <strong>Role</strong>
        </p>
        <p><%= @user.role.name.titleize.humanize %></p>

        <% if !current_user.nil? and current_user == @user %>
            <p style="margin-bottom: 0px;">
              <strong>Account email</strong>
            </p>
            <p><%= @user.email %></p>

            <p style="margin-bottom: 0px;">
              <strong>Authentication
                token</strong><span class="empty" style="font-style: italic;"> (keep it secret)</span>
            </p>
            <p><%= @user.authentication_token %></p>
        <% end %>

        <% if !current_user.nil? and current_user == @user %>
            <div class="row">
              <%= link_to "Manage account", edit_user_registration_path, :class => 'btn btn-default center-block' %>
            </div>
        <% end %>
      </li>
    </ul>
  </div>

  <div class="col-md-9">
    <div class="page-header">
      <h2>User <%= "#{@user.username}" %></h2>
    </div>
    <div class="row">
      <div class="content_action col-md-6">
        <% if !current_user.nil? and policy(@user).update? %>
            <% if current_user == @user %>
                <%= link_to "Manage account", edit_user_registration_path, :class => 'btn btn-default pull-right' %>
            <% end %>
            <%= link_to t('.edit', :default => 'Edit profile'),
                        edit_user_path(@user), :class => 'btn btn-primary pull-right', :style => "margin-right: 5px;" %>
        <% end %>
        <% if !current_user.nil? and policy(@user).destroy? %>
            <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
                        user_path(@user),
                        :method => 'delete',
                        :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) },
                        :class => 'btn btn-danger pull-right', :style => "margin-right: 5px;" %>
        <% end %>
        <%= link_to t('.back', :default => t("helpers.links.back")),
                    users_path, :class => 'btn btn-info pull-right', :style => "margin-right: 5px;" %>
      </div>
    </div>

    <div class="row">
      <% materials = @user.materials.limit(resource_limit) %>
      <% upcoming_events = @user.events.not_finished %>
      <% past_events = @user.events.finished %>
      <% events = upcoming_events.limit(resource_limit) %>
      <% packages = @user.packages.visible_by(current_user) %>
      <% workflows = @user.workflows.visible_by(current_user) %>

      <ul class="nav nav-tabs">
        <%= tab('Materials', icon_class_for_model('materials'), 'materials', active: true,
                disabled: { check: materials.none?, message: 'No registered training materials' },
                count: @user.materials.count) %>

        <%= tab('Events', icon_class_for_model('events'), 'events',
                disabled: { check: events.none?, message: 'No registered events' },
                count: @user.events.count) %>

        <%= tab('Packages', icon_class_for_model('packages'), 'packages',
                disabled: { check: packages.none?, message: 'No packages' },
                count: packages.count) %>

        <%= tab('Workflows', icon_class_for_model('workflows'), 'workflows',
                disabled: { check: workflows.none?, message: 'No workflows' },
                count: workflows.count) %>
      </ul>

      <div class="tab-content">
        <div id="materials" class="tab-pane fade in active">
          <div class="row">
            <div class="search-results-count">
              <%= (materials.count > 0 ? "Showing" : "Found") + " #{pluralize(materials.count, "material")}#{(@user.materials.count > resource_limit) ? " out of #{@user.materials.count}" : ''}." %>
              <%= link_to('View all results.', materials_path(user: @user.username)) if (@user.materials.count > resource_limit) %>
            </div>

            <% materials.each do |material| %>
                <%= render material %>
            <% end %>
          </div>
        </div>
        <div id="events" class="tab-pane fade">
          <div class="row">
            <div class="search-results-count">
              <%= (upcoming_events.count > 0 ? "Showing" : "Found") + " #{pluralize(events.count, "upcoming event")}#{(upcoming_events.count > resource_limit) ? " out of #{upcoming_events.count}" : ''}." %>
              <%= "Found #{pluralize(past_events.count, "past event")}." %>
              <%= link_to('View all results.', events_path(user: @user.username)) if (upcoming_events.count > resource_limit || past_events.count > 0) %>
            </div>
            <% if events.count > 0 %>
                <ul class="masonry media-grid" style="margin-top: 15px;">
                  <% events.each do |event| %>
                      <%= render event %>
                  <% end %>
                </ul>
            <% end %>
          </div>
        </div>
        <div id="packages" class="tab-pane fade">
          <div class="row">
            <div class="search-results-count">
              <%= pluralize(packages.count, 'package') %> found
            </div>
            <% if packages.any? %>
                <ul class="masonry media-grid" style="margin-top: 15px;">
                  <% packages.each do |package| %>
                      <%= render package %>
                  <% end %>
                </ul>
            <% end %>
          </div>
        </div>
        <div id="workflows" class="tab-pane fade">
          <div class="row">
            <div class="search-results-count">
              <%= pluralize(workflows.count, 'workflow') %> found
            </div>
            <% if workflows.any? %>
                <ul class="masonry media-grid" style="margin-top: 15px;">
                  <% workflows.each do |workflow| %>
                      <%= render workflow %>
                  <% end %>
                </ul>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
