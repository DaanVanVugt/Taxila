<script>
  $(document).ready(function () {
    reposition_tiles('masonry', 'masonry-brick');
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
      reposition_tiles('masonry', 'masonry-brick');
    })
  })
</script>
<div class="wrapper collapsing-wrapper">
  <!-- SIDEBAR -->
  <div class="collapsing-sidebar" id="sidebar">
    <%= render :partial => "content_providers/partials/content_provider_info", :locals => {:content_provider => @content_provider} %>
  </div>
  <div id="content">
    <div class="row">
      <!-- ACTION BUTTONS -->
      <div class="content_action">
        <%= link_to t('.back', :default => t("helpers.links.back")),
                    content_providers_path, :class => 'btn btn-info' %>
        <% if !current_user.nil? and policy(@content_provider).update? %>
            <%= link_to t('.edit', :default => t("helpers.links.edit")),
                        edit_content_provider_path(@content_provider), :class => 'btn btn-primary' %>
        <% end %>
        <% if !current_user.nil? and policy(@content_provider).destroy? %>
            <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
                        content_provider_path(@content_provider),
                        :method => 'delete',
                        :data => {:confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?'))},
                        :class => 'btn btn-danger' %>
        <% end %>
      </div>
    </div>
    <div class="row">
      <ul class="nav nav-tabs">
        <li <%= "class=active" if @content_provider.materials.count > 0 or @content_provider.events.count < 1 %>>
          <a data-toggle="tab" href="#materials"><i class="<%= icon_class_for_model('materials') %>"></i> Materials</a>
        </li>
        <li <%= "class=active" if @content_provider.events.count > 0 and @content_provider.materials.count < 1 %>>
          <a data-toggle="tab" href="#events"><i class="<%= icon_class_for_model('events') %>"></i> Events</a>
        </li>
        <li>
          <a data-toggle="tab" href="#activity_log"><i class="<%= icon_class_for_model('activity_logs') %>"></i>
            Activity log</a>
        </li>
      </ul>

      <div class="tab-content">
        <div id="materials" class="tab-pane fade 
              <%= "in active" if @content_provider.materials.count > 0 or @content_provider.events.count < 1 %>
          ">
          <div class="row">
            <% materials = @content_provider.materials.count > 30 ? @content_provider.materials.first(30) : @content_provider.materials %>
            <div class="search-results-count"> 
              <%= (materials.count > 0 ? "Showing" : "Found") + " #{pluralize(materials.count, "material")}#{(@content_provider.materials.count > 30) ? " out of #{@content_provider.materials.count}" : ''}." %>
              <%= link_to "View all results.", :controller => 'materials', :content_provider => @content_provider.title if (@content_provider.materials.count > 30) %>
            </div>

            <% materials.each do |material| %> 
                <%= render material %> 
            <% end %> 
          </div>
        </div>
        <div id="events" class="tab-pane fade
              <%= "in active" if @content_provider.events.count > 0 and @content_provider.materials.count < 1 %>
          ">
          <div class="row">
            <% upcoming_events = @content_provider.events.select{|x| x.upcoming?} %>
            <% past_events = @content_provider.events.select{|x| x.expired?} %>

            <div class="row">
              <% events = upcoming_events.count > 30 ? upcoming_events.first(30) : upcoming_events %>
              <div class="search-results-count"> 
                <%= (upcoming_events.count > 0 ? "Showing" : "Found") + " #{pluralize(events.count, "upcoming event")}#{(upcoming_events.count > 30) ? " out of #{upcoming_events.count}" : ''}." %>
                <%= "Found #{pluralize(past_events.count, "past event")}." %>
                <%= link_to "View all results.", :controller => 'events', :content_provider => @content_provider.title if (upcoming_events.count > 30 || past_events.count > 0) %>
              </div>
              <% if upcoming_events.count > 0 %>
                  <ul class="masonry media-grid" style="margin-top: 15px;">
                    <% upcoming_events.each do |upcoming_event| %> 
                        <%= render upcoming_event %> 
                    <% end %> 
                  </ul>
              <% end %>
            </div>
          </div>
        </div>
        <div id="activity_log" class="tab-pane fade">
          <%= render :partial => "activities/activity_log", :locals => {:resource => @content_provider} %>
        </div>
      </div>
    </div>
  </div>
</div>
