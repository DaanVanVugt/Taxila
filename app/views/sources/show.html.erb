<div class="wrapper collapsing-wrapper">

  <%# SIDEBAR %>
  <div class="collapsing-sidebar" id="sidebar">
    <%= render partial: "content_providers/partials/content_provider_info",
               locals: { content_provider: @source.content_provider } %>
  </div>

  <div id="content">
    <div class="row">
      <div class="content_action">
        <%= link_to 'Back', sources_path, class: "btn btn-info" %>

        <% if !current_user.nil? and policy(@source).update? %>
          <%= link_to t('.edit', default: t("helpers.links.edit")),
                      edit_source_path(@source), class: 'btn btn-primary' %>
        <% end %>

        <% if !current_user.nil? and policy(@source).destroy? %>
          <%= link_to t('.destroy', default: t("helpers.links.destroy")),
                      source_path(@source),
                      method: 'delete',
                      data: { confirm: t('.confirm', default: t("helpers.links.confirm", default: 'Are you sure?')) },
                      class: 'btn btn-danger' %>
        <% end %>
        <%= link_to @source.url, class: 'btn btn-success', target: '_blank', rel: 'noopener' do %>
          <span class="fa fa-external-link"></span> View URL
        <% end %>
      </div>
    </div>

    <div class="row">
      <ul class="nav nav-tabs">
        <%= tab('Source', icon_class_for_model('source'), 'home', active: true) %>
        <%= tab('Testing', icon_class_for_model('testing'), 'testing') %>
      </ul>

      <div class="tab-content">
        <div id="home" class="tab-pane fade in active">
          <div class="row">
            <div>

              <h4>Source Details</h4>

              <!-- Field: URL -->
              <p class="url-wrap">
                <strong>URL:</strong>
                <%= link_to @source.url, @source.url, target: '_blank', rel: 'noopener' %>
              </p>

              <!-- Field: method -->
              <p><strong>Method:</strong>
                <%= @source.ingestor_title %>
              </p>

              <!-- Field: created at -->
              <p><strong>Created at:</strong>
                <%= @source.created_at.strftime('%H:%M on %A, %d %B %Y (UTC)') %>
              </p>

              <!-- Field: token -->
              <% if !current_user.nil? and (current_user.is_curator? or current_user.is_admin?) %>
                <p><strong>Token:</strong>
                  <%= @source.token %>
                </p>
              <% end %>

              <!-- Field: enabled -->
              <p>
                <strong>Source is:</strong>
                <%= source_enabled_badge(@source.enabled) %>
              </p>

              <% if TeSS::Config.feature['user_source_creation'] %>
                <p>
                  <strong>Approval status:</strong>
                  <%= source_approval_badge(@source.approval_status) %>
                </p>

                <% if policy(@source).update? && !@source.approval_requested? && !@source.approved? %>
                  <%= link_to 'Request Approval', request_approval_source_path(@source),
                              data: { confirm: 'Are you sure you wish to submit this source for approval? You will not be able to modify it afterwards.'},
                              method: :post, class: 'btn btn-primary' %>
                <% end %>

                <% if policy(@source).approve? && !@source.approved? %>
                  <%= link_to 'Approve', source_path(@source, source: { approval_status: 'approved' }),
                              method: :put, class: 'btn btn-success' %>
                <% end %>
              <% end %>

              <hr/>

              <%# Show details of last run %>
              <div class="col-md-3">
                <h4>Last Run</h4>
                <% if @source.finished_at.nil? %>
                  <p><strong>No results found</strong></p>
                <% else %>
                  <p><strong>Finished at:</strong></p>
                  <p><strong>Time:</strong>
                    <%= @source.finished_at.strftime('%H:%M (UTC)') %>
                  </p>
                  <p><strong>Date:</strong>
                    <%= @source.finished_at.strftime('%a, %d %B %Y') %>
                  </p>
                  <table class="table">
                    <thead>
                    <tr>
                      <th scope="col">Records</th>
                      <th scope="col">Count</th>
                    </tr>
                    </thead>
                    <tr>
                      <th scope="row">read</th>
                      <td><%= @source.records_read %></td>
                    </tr>
                    <tr>
                      <th scope="row">written</th>
                      <td><%= @source.records_written %></td>
                    </tr>
                    <tr>
                      <th scope="row">added</th>
                      <td><%= @source.resources_added %></td>
                    </tr>
                    <tr>
                      <th scope="row">updated</th>
                      <td><%= @source.resources_updated %></td>
                    </tr>
                    <tr>
                      <th scope="row">rejected</th>
                      <td><%= @source.resources_rejected %></td>
                    </tr>
                  </table>
                <% end %>
              </div>

              <%# Show details of log %>
              <% unless @source.log.nil? %>
                <div class="col-md-9">
                  <h4>Output</h4>
                  <div class="panel-body"
                       style="width: 100%; height: 300px ;overflow-y: scroll">
                    <%= render_markdown(@source.log.html_safe) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
          <%= render partial: 'activities/activity_log_button', locals: { resource: @source } %>
        </div>
        <div id="testing" class="tab-pane">
          <div class="row">
            <%= render partial: 'sources/test' %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

