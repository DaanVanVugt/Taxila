<% sample_size ||= 20 %>

<h2>Results</h2>
<strong>Run time:</strong> <%= test_results[:run_time].round(2) %>s
<% unless test_results[:messages].blank? %>
  <h3>Log</h3>
  <pre>
  <%= test_results[:messages].join("\n") %>
</pre>
<% end %>

<% ['events', 'materials'].each do |type| %>
  <% resources = test_results[type.to_sym] || [] %>
  <% klass = type.singularize.capitalize.constantize %>
  <% sample = resources.sample(sample_size) %>

  <%= content_tag(:div, id: type, class: 'scraper-typed-results') do %>
    <h3>
      <%= pluralize(resources.count, type.singularize) %> found
      <% if sample.count < resources.count %>
        - showing <%= pluralize(sample.count, 'sample') %>
      <% end %>
    </h3>
    <% sample.each do |resource_params| %>
      <% resource = type.singularize.capitalize.constantize.new(resource_params.merge(user: User.get_default_user,
                                                                                      content_provider: @content_provider)) %>
      <% existing = klass.check_exists(resource) %>
      <div class="list-card bulk-import-row<%= ' new' unless existing -%>">
        <h4>
          <% if existing %>
            <%= link_to(existing, target: :_blank, class: 'btn btn-xs btn-default pull-right') do %>
              Current <%= TeSS::Config.site['title_short'] %> entry
              <span class="fa fa-external-link"></span>
            <% end %>
          <% end %>
          <%= resource.title %>
        </h4>
        <p>
          <%= link_to(resource.url, resource.url, target: :_blank) %>
        </p>
        <div class="scraped-metadata">
          <% if type == 'events' %>
            <%= display_attribute(resource, :start) { |t| t.strftime('%A, %d %B %Y @ %H:%M') }%>
            <%= display_attribute(resource, :end) { |t| t.strftime('%A, %d %B %Y @ %H:%M') } %>
            <%= display_attribute(resource, :timezone) %>
            <%= display_attribute(resource, :duration) %>
          <% end %>
          <% unless resource.valid? %>
            <div class="alert alert-danger">
              <i class="fa fa-exclamation-circle"></i> Errors: <%= resource.errors.full_messages.join(', ') %>
            </div>
          <% end %>
          <%= render partial: 'common/extra_metadata', locals: { resource: resource, hide_title: true } %>
        </div>
      </div>
    <% end %>
  <% end %>

  <hr/>

<% end %>
