<hr/>
<% sample_size ||= 5 %>
<h4>Bioschemas summary:</h4>
<table class="table" style="max-width: 20em">
  <% @output[:totals].each do |type, total| %>
    <tr><td><%= type %></td><td><%= total %></td></tr>
  <% end %>
</table>

<h4>As <%= TeSS::Config.site['title_short'] %> resources:</h4>
<% results_count = 0 %>
<% ['events', 'materials'].each do |type| %>
  <% resources = @output[:resources][type.to_sym] || [] %>
  <% results_count += resources.count %>
  <% klass = type.singularize.capitalize.constantize %>
  <% sample = resources.sample(sample_size) %>
  <% next if resources.none? %>

  <h5><%= pluralize(resources.count, type.singularize) -%></h5>
  <div>
    <% if sample.count < resources.count %>
      Showing <%= pluralize(sample.count, 'sample') %>
    <% end %>
    <% sample.each do |resource_params| %>
      <% resource = Source.get_test_resource(type, resource_params, user: User.get_default_user,
                                             content_provider: @content_provider) %>
      <% existing = klass.check_exists(resource) %>
      <div class="list-card bulk-import-row<%= ' new' unless existing -%>">
        <h4>
          <% if existing %>
            <%= link_to(existing, target: '_blank', class: 'btn btn-xs btn-default pull-right') do %>
              Current <%= TeSS::Config.site['title_short'] %> entry
              <span class="fa fa-external-link"></span>
            <% end %>
          <% end %>
          <%= resource.title %>
        </h4>
        <p>
          <%= link_to(resource.url, resource.url, target: '_blank', rel: 'noopener') %>
        </p>
        <div class="scraped-metadata">
          <% if type == 'events' %>
            <%= display_attribute(resource, :start) { |t| t.strftime('%A, %d %B %Y @ %H:%M') }%>
            <%= display_attribute(resource, :end) { |t| t.strftime('%A, %d %B %Y @ %H:%M') } %>
            <%= display_attribute(resource, :timezone) %>
            <%= display_attribute(resource, :duration) %>
          <% end %>
          <%= render partial: 'common/extra_metadata', locals: { resource: resource } %>
          <% if resource.valid? %>
            <%= render partial: 'bioschemas/preview_button', locals: { resource: resource } %>
          <% else %>
            <div class="alert alert-danger">
              <i class="fa fa-exclamation-circle"></i> Errors: <%= resource.errors.full_messages.join(', ') %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% end %>
<% if results_count == 0 %>
  <span class="muted">No resources were found</span>
<% end %>
